<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>api-test-suite token generator</title>

<style>
:root {
	--background: #eee;
	--body-color: #333;
	--body-cap: 430px;
	--spacing: 8px;
	--corner: 3px;
}

body {
	max-width: var(--body-cap);

	margin: auto;

	background: var(--background);
	color: var(--body-color);
	font: Garamond, Georgia, "Times New Roman", Times, serif;
	font-size: 11pt;
}

dl {
	
	padding: var(--spacing);
	border-radius: var(--corner);
	
	background: #f9f9f9;
	font-family: Lucida Grande, Helvetica Neue, Helvetica, Arial, sans-serif;
}

hr {
	height: 0px;
	border: 0.5px solid var(--body-color);
	opacity: 0.3;
}

#target {
	padding: var(--spacing);
	margin: var(--spacing) 0;
	border-radius: var(--corner);

	background: #fdffb8;

	display: flex;

	flex-direction: column;
}

#target > * {
	margin-bottom: var(--spacing);
}

#target button {
	align-self: start;
}

#target textarea {
	font-size: 80%;
}

.hidden {
	display: none !important;
}
</style>

<script type="module">
import util from './util.js';

const mod = {

	config: {
		server: '$SERVER_URL',
		account: '$ACCOUNT',
		scope: '$TOKEN_SCOPE',
		token_read_write: '$TOKEN_READ_WRITE',
		token_read_only: '$TOKEN_READ_ONLY',
	},

	target: {},

	// actions

	async webfinger () {
		window.webfinger.innerText = JSON.stringify(mod._webfinger = await util.webfinger.discover(mod.config.server, mod.config.account), null, ' ');

		if (mod._webfinger) {
			window.oauth_read_write.removeAttribute('disabled');
			window.oauth_read_only.removeAttribute('disabled');
		}
	},

	async token_read_write () {
		location.href = `${ util.webfinger.auth(mod._webfinger) }?${ new URLSearchParams({
			redirect_uri: location.href,
			scope: `${ mod.config.scope }:rw`,
			response_type: 'token',
			client_id: location.href,
			state: mod.marshal({
				account: mod.config.account,
				purpose: 'token_read_write',
			}),
		}) }`
	},

	async token_read_only () {
		location.href = `${ util.webfinger.auth(mod._webfinger) }?${ new URLSearchParams({
			redirect_uri: location.href,
			scope: `${ mod.config.scope }:r`,
			response_type: 'token',
			client_id: location.href,
			state: mod.marshal({
				account: mod.config.account,
				purpose: 'token_read_only',
			}),
		}) }`
	},

	reset () {
		const uri = window.location.toString();

		window.history.replaceState({}, document.title, uri.substring(0, uri.indexOf("#")))

		window.target.innerHTML = '';

		window.target.classList.add('hidden');

		window.nostate.classList.remove('hidden');
	},

	// utilities

	marshal: state => btoa(JSON.stringify(state)),

	unmarshal: state => JSON.parse(atob(state)),

	process (params) {
		if (params.state.account && params.state.purpose) {
			mod.target[params.state.purpose] = params.access_token

			window.target.classList.remove('hidden');

			window.target.appendChild(Object.assign(document.createElement('strong'), {
				innerHTML: 'Add the following line to your <code>.env</code> file',
			}));

			window.target.appendChild(Object.assign(document.createElement('textarea'), {
				value: `${ {
					token_read_write: 'TOKEN_READ_WRITE',
					token_read_only: 'TOKEN_READ_ONLY',
				}[params.state.purpose] }="${ params.access_token }"`,
				disabled: true,
			}));

			window.target.appendChild(Object.assign(document.createElement('button'), {
				innerText: 'clear state',
				onclick: mod.reset,
			}));

			window.nostate.classList.add('hidden');
		}
	},

	// lifecycle

	DOMContentLoaded () {
		Object.keys(mod.config).forEach(e => {
			mod.config[e] = mod.config[e].replace('undefined', '');
		});

		if (!mod.config.scope)
			mod.config.scope = 'api-test-suite';

		if (!mod.config.token_read_write)
			window.oauth_read_write.disabled = true;

		if (!mod.config.token_read_only)
			window.oauth_read_only.disabled = true;

		const params = Object.fromEntries(new window.URLSearchParams(window.location.hash.slice(1)));
		
	  if (params.state)
	    params.state = mod.unmarshal(params.state);

	  if (params.access_token)
	  	mod.process(params);

	  Object.keys(mod.config).forEach(e => window[e].innerHTML = mod.config[e] || '<b>[not set]</b>');
	},

};

document.addEventListener('DOMContentLoaded', mod.DOMContentLoaded);

window.mod = mod;
</script>

</head>
<body>

<h1>token generator</h1>

<dl>

<dt>SERVER_URL</dt>
<dd id="server">…</dd>

<dt>ACCOUNT</dt>
<dd id="account">…</dd>

<dt>TOKEN_SCOPE</dt>
<dd id="scope">…</dd>

<dt>TOKEN_READ_WRITE</dt>
<dd id="token_read_write">…</dd>

<dt>TOKEN_READ_ONLY</dt>
<dd id="token_read_only">…</dd>

<div id="nostate">
	<hr>

	<button onclick="mod.webfinger()">webfinger</button>
	<pre id="webfinger"></pre>

	<p><button id="oauth_read_write" onclick="mod.token_read_write()" disabled>token_read_write</button></p>
	
	<p><button id="oauth_read_only" onclick="mod.token_read_only()" disabled>token_read_only</button></p>
</div>

<div id="target" class="hidden"></div>

</dl>

</body>
</html>
